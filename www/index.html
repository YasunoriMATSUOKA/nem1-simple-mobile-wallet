<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy"
    content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <script src="lib/nem-sdk/nem-sdk.js"></script>

  <script>
    //Load nem-sdk
    var nem = require("nem-sdk").default;

    //Onsen UI is ready
    ons.ready(function () {
      console.log("Onsen UI is ready!");
    });

    //Escape
    function htmlEscape(s){
      s = s.replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#x27;");
      return s;
    }
    
    //Validate privateKey and if OK get privateKey strings
    function getPrivateKey(privateKey){
      if(privateKey){
        var keyPair = nem.crypto.keyPair.create(htmlEscape(privateKey));
        var publicKey = keyPair.publicKey.toString();
        var address = nem.model.address.toAddress(publicKey, nem.model.network.data.mainnet.id);
        var isValid = nem.model.address.isValid(address);
        if(isValid){
          return privateKey;
        }else{
          ons.notification.toast("エラー：アドレスが異常です！適切な秘密鍵を設定タブから登録してください。", { timeout: 1000, animation: 'fall' });
          return "";
        }
      }else{
        ons.notification.toast("秘密鍵が未登録です！設定タブから登録してご利用ください。", { timeout: 1000, animation: 'fall' });
        return "";
      }
    }

    //Validate address and if OK get address strings
    function getAddress(privateKey){
      if(privateKey){
        var keyPair = nem.crypto.keyPair.create(htmlEscape(privateKey));
        var publicKey = keyPair.publicKey.toString();
        var address = nem.model.address.toAddress(publicKey, nem.model.network.data.mainnet.id);
        var isValid = nem.model.address.isValid(address);
        if(isValid){
          return address;
        }else{
          ons.notification.toast("エラー：アドレスが異常です！適切な秘密鍵を設定タブから登録してください。", { timeout: 1000, animation: 'fall' });
          return "";
        }
      }else{
        ons.notification.toast("秘密鍵が未登録です！設定タブから登録してご利用ください。", { timeout: 1000, animation: 'fall' });
        return "";
      }
    }
    
    //Set QR address
    function setQrAddress(){
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data="' + getAddress(localStorage.privateKey) + '"';
      document.getElementById("qrAddress").setAttribute("src", url);
    }

    document.addEventListener('show', function (event) {
      var page = event.target;
      var titleElement = document.querySelector('#toolbar-title');

      if (page.matches('#home-page')) {
        titleElement.innerHTML = 'ホーム';
        document.getElementById("address").innerText = getAddress(localStorage.privateKey);
        setQrAddress();
      } else if (page.matches('#send-page')) {
        titleElement.innerHTML = '送付';
      } else if (page.matches('#receive-page')) {
        titleElement.innerHTML = '受取';
      } else if (page.matches('#history-page')) {
        titleElement.innerHTML = '履歴';
      } else if (page.matches('#settings-page')) {
        titleElement.innerHTML = '設定';
        document.getElementById("privateKeySet").value = getPrivateKey(localStorage.privateKey);
        document.getElementById("addressChecked").innerText = getAddress(localStorage.privateKey);
      }
    });

    if (ons.platform.isIPhoneX()) {
      document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
      document.documentElement.setAttribute('onsflag-iphonex-landscape', '');
    }

    //Set private key
    function setPrivateKey(){
      const privateKey = htmlEscape(document.getElementById("privateKeySet").value);
      const address = getAddress(privateKey);
      if(address !== null){
        document.getElementById("addressChecked").value = address;
        localStorage.setItem("privateKey", privateKey);
        document.getElementById("privateKeySet").value = "";
        ons.notification.toast("秘密鍵を登録しました。", { timeout: 1000, animation: 'fall' })
      }else{
        //
      }
    }
    
    //Delete private key
    function deletePrivateKey(){
      localStorage.removeItem("privateKey");
      ons.notification.toast("秘密鍵を削除しました。", { timeout: 1000, animation: 'fall' });
    }
    
    //Set exchange info
    function setExchangeInfo(){
      const apiKey = htmlEscape(document.getElementById("apiKeySet").value);
      const apiSecret = htmlEscape(document.getElementById("apiSecretSet").value);
      const depositAddress = htmlEscape(document.getElementById("depositAddress").value);
      const depositMessage = htmlEscape(document.getElementById("depositMessage").value);
      //Todo: Set info must be validated here
      localStorage.setItem("apiKey", apiKey);
      localStorage.setItem("apiSecret", apiSecret);
      localStorage.setItem("depositAddress", depositAddress);
      localStorage.setItem("depositMessage", depositMessage);
      ons.notification.toast("取引所連携情報を登録しました。", { timeout: 1000, animation: 'fall' })
      document.getElementById("apiKeySet").value = "";
      document.getElementById("apiSecret").value = "";
      document.getElementById("depositAddress").value = "";
      document.getElementById("depositMessage").value = "";
    }
    
    //delete exchange info
    function deleteExchangeInfo(){
      localStorage.removeItem("apiKey");
      localStorage.removeItem("apiSecret");
      localStorage.removeItem("depositAddress");
      localStorage.removeItem("depositMessage");
      ons.notification.toast("取引所連携情報を削除しました。", { timeout: 1000, animation: 'fall' });
    }

    //Transfer Tx
    function transferTx(){
      const recipientAddress = htmlEscape(document.getElementById("recipientAddress").value).replace(/-/g, "").trim();
      const amount = htmlEscape(document.getElementById("sendAmount").value);
      const message = htmlEscape(document.getElementById("sendMessage").value);
      var transferTx = nem.model.objects.create("transferTransaction")(recipientAddress, amount, message);
      var common = nem.model.objects.create("common")("", localStorage.privateKey);
      var transactionEntity = nem.model.transactions.prepare("transferTransaction")(common, transferTx, nem.model.network.data.mainnet.id);
      var endpoint = nem.model.objects.create("endpoint")(nem.model.nodes.defaultMainnet, nem.model.nodes.defaultPort);
      nem.model.transactions.send(common, transactionEntity, endpoint).then(
        function(res){
          if(htmlEscape(res.message) === "SUCCESS"){
            var transactionResult = "送付に成功しました。";
            var transactionHashResult = htmlEscape(res.transactionHash.data);
            var alertMessage = transactionResult + "\nトランザクションのハッシュは\n" + transactionHashResult + "\nです。";
            document.getElementById("recipientAddress").value = "";
            document.getElementById("sendAmount").value = "";
            document.getElementById("sendMessage").value = "";
          }else{
            var transactionResult = "エラー：送付に失敗しました！";
            var alertMessage = transactionResult;
          }
          ons.notification.toast(alertMessage, { timeout: 1000, animation: 'fall' });
        }
      );
    }
  </script>
</head>

<body>
  <ons-page>
    <ons-toolbar>
      <div class="center" id="toolbar-title"></div>
    </ons-toolbar>
    <ons-tabbar position="auto">
      <ons-tab label="ホーム" page="home.html" icon="home" active>
      </ons-tab>
      <ons-tab label="送付" page="send.html" icon="paper-plane">
      </ons-tab>
      <ons-tab label="受取" page="receive.html" icon="qrcode">
      </ons-tab>
      <ons-tab label="履歴" page="history.html" icon="list">
      </ons-tab>
      <ons-tab label="設定" page="settings.html" icon="cog">
      </ons-tab>
    </ons-tabbar>
  </ons-page>

  <ons-template id="home.html">
    <ons-page id="home-page">
      <ons-list>
        <ons-list-header>ウォレット</ons-list-header>
        <ons-list-item modifier="nodivider">
          <div class="left">通貨</div>
          <div class="right">
            <ons-select>
              <select id="currency">
                <option value="XEM">XEM</option>
              </select>
            </ons-select>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">アドレス</div>
          <div id="address" class="right" style="font-size: 10px;"></div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">QRコード</div>
          <div class="right">
              <img id="qrAddress">
          </div>
        </ons-list-item>
      </ons-list>
      <ons-list>
        <ons-list-header>取引所</ons-list-header>
        <ons-list-item modifier="nodivider">
          <div class="left"></div>
        </ons-list-item>
      </ons-list>
    </ons-page>
  </ons-template>

  <ons-template id="send.html">
    <ons-page id="send-page">
      <ons-list>
        <ons-list-header>QRコードをスキャンして支払い</ons-list-header>
        <ons-list-item modifier="nodivider"></ons-list-item>
        <ons-list-header>手入力で支払い</ons-list-header>
        <ons-list-item modifier="nodivider">
          <div class="left">アドレス(必須)</div>
          <div class="right">
            <ons-input id="recipientAddress" float placeholder="アドレスを入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">数量(必須)</div>
          <div class="right">
            <ons-input id="sendAmount" type="number" float placeholder="数量を入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">メッセージ(任意)</div>
          <div class="right">
            <ons-input id="sendMessage" type="string" float placeholder="メッセージを入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">
            <ons-button onclick="transferTx()">送信</ons-button>
          </div>
          <div class="right">
            <ons-button>入力値クリア</ons-button>
          </div>
        </ons-list-item>
      </ons-list>
    </ons-page>
  </ons-template>

  <ons-template id="receive.html">
    <ons-page id="receive-page">
      <p style="text-align: center;">
        This is the receive page.
      </p>
    </ons-page>
  </ons-template>

  <ons-template id="history.html">
    <ons-page id="history-page">
      <p style="text-align: center;">
        This is the history page.
      </p>
    </ons-page>
  </ons-template>

  <ons-template id="settings.html">
    <ons-page id="settings-page">
      <ons-list>
        <ons-list-header>ウォレットの設定</ons-list-header>
        <ons-list-item modifier="nodivider">
          <div class="left">通貨</div>
          <div class="right">
            <ons-select>
              <select id="currencySelected">
                <option value="XEM">XEM</option>
              </select>
            </ons-select>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">秘密鍵</div>
          <div class="right">
            <ons-input id="privateKeySet" type="password" placeholder="秘密鍵を入力" style="font-size: 10px;"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">アドレス</div>
          <div class="right" style="font-size: 10px;" id="addressChecked"></div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">
            <ons-button onclick="setPrivateKey()">保存</ons-button>
          </div>
          <div class="right">
            <ons-button onclick="deletePrivateKey()">削除</ons-button>
          </div>
        </ons-list-item modifier="nodivider">
        <ons-list-header>取引所設定</ons-list-header>
        <ons-list-item modifier="nodivider">
          <div class="left">取引所</div>
          <div class="right">
            <ons-select>
              <select id="exchangeSel">
                <option value="zaif">Zaif</option>
              </select>
            </ons-select>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">API Key</div>
          <div class="right">
            <ons-input id="apiKeySet" type="text" placeholder="API Keyを入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">API Secret</div>
          <div class="right">
            <ons-input id="apiKeySet" type="password" placeholder="API Secretを入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">入金アドレス</div>
          <div class="right">
            <ons-input id="apiKeySet" type="text" placeholder="取引所入金アドレス入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">入金メッセージ</div>
          <div class="right">
            <ons-input id="apiKeySet" type="text" placeholder="取引所入金メッセージ入力"></ons-input>
          </div>
        </ons-list-item>
        <ons-list-item modifier="nodivider">
          <div class="left">
            <ons-button onclick="setExchangeInfo()">保存</ons-button>
          </div>
          <div class="right">
            <ons-button onclick="deleteExchangeInfo()">削除</ons-button>
          </div>
        </ons-list-item>
      </ons-list>
    </ons-page>
  </ons-template>

</body>

</html>